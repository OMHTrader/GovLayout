<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gov → Policy → Public Co. (Triangle — One-by-one)</title>
  <style>
    :root{ --bg:#0f172a; --panel:#0b1222; --text:#e5e7eb; --sub:#94a3b8; --border:#334155; }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      background:var(--bg); color:var(--text); font-size:18px; line-height:1.45;
    }
    header{
      position:sticky; top:0; z-index:1000;
      background:#0f172ad0; border-bottom:1px solid var(--border); backdrop-filter:saturate(1.05) blur(6px);
    }
    .wrap{ max-width:1400px; margin:0 auto; padding:12px 16px; }
    h1{ margin:0; font-size:22px }
    .controls{ display:grid; gap:10px; grid-template-columns:1fr; margin-top:10px }
    @media (min-width:780px){ .controls{ grid-template-columns:2fr 1.2fr .8fr .9fr } }
    input, select, button{
      background:#0b1222; color:var(--text); border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; font-size:16px;
    }
    button:disabled{ opacity:.5; cursor:not-allowed }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .muted{ color:var(--sub); font-size:14px }
    svg text{ font-family:inherit }
    .bar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:10px 0 0 }
    .pill{ padding:4px 10px; border:1px solid var(--border); border-radius:999px; background:#0f172a; font-size:12px; color:var(--sub) }
    .idx{ font-size:13px; color:var(--sub); min-width:56px; text-align:center }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Gov → Policy → Public Co. (Upside-Down Triangle)</h1>
      <div class="controls">
        <input id="searchTicker" list="tickersList" placeholder="Type a ticker (ACME, OMRB, RDW)…" />
        <datalist id="tickersList"></datalist>

        <select id="tickerSelect">
          <option value="">Select a ticker…</option>
        </select>

        <button id="clearSel">Clear</button>
        <button id="openTimeline" disabled>Open timeline →</button>
      </div>
      <div class="muted" id="hostHint" style="display:none;margin-top:6px"></div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px">
    <section class="panel" style="overflow:hidden">
      <svg id="canvas" viewBox="0 0 1400 720" preserveAspectRatio="xMidYMid meet" style="width:100%;height:66vh">
        <!-- guides -->
        <g fill="none" stroke="rgba(255,255,255,.06)">
          <line x1="300" y1="0" x2="300" y2="720"/>
          <line x1="700" y1="0" x2="700" y2="720"/>
          <line x1="1140" y1="0" x2="1140" y2="720"/>
          <line x1="420" y1="620" x2="980" y2="620"/>
        </g>

        <!-- labels -->
        <g font-size="14" fill="#94a3b8">
          <text x="160"  y="32">Members</text>
          <text x="1190" y="32">Public Companies</text>
          <text x="650"  y="702">Policies / Laws / Rulings</text>
        </g>

        <!-- edges -->
        <g id="edges-ma" fill="none" stroke="#f59e0b" stroke-opacity=".95" stroke-linecap="round"></g>
        <g id="edges-ac" fill="none" stroke="#3b82f6" stroke-opacity=".95" stroke-linecap="round"></g>
        <g id="edges-mc" fill="none" stroke="#ef4444" stroke-opacity=".95" stroke-linecap="round"></g>

        <!-- nodes (one each) -->
        <g id="member"></g>
        <g id="artifact"></g>
        <g id="company"></g>

        <!-- labels (on top) -->
        <g id="labels"></g>
      </svg>

      <!-- one-by-one nav bars -->
      <div class="bar" id="memberBar">
        <button id="prevM">◀ Prev member</button>
        <span class="idx" id="mIdx">0/0</span>
        <button id="nextM">Next member ▶</button>
        <span class="pill" id="mName">—</span>
      </div>

      <div class="bar" id="artifactBar">
        <button id="prevA">◀ Prev policy</button>
        <span class="idx" id="aIdx">0/0</span>
        <button id="nextA">Next policy ▶</button>
        <span class="pill" id="aName">—</span>
      </div>

      <div class="muted" style="margin-top:10px">
        <span style="background:#f59e0b;display:inline-block;width:14px;height:4px;border-radius:3px;vertical-align:middle"></span>
        Member→Policy
        &nbsp;&nbsp; <span style="background:#3b82f6;display:inline-block;width:14px;height:4px;border-radius:3px;vertical-align:middle"></span>
        Policy→Company
        &nbsp;&nbsp; <span style="background:#ef4444;display:inline-block;width:14px;height:4px;border-radius:3px;vertical-align:middle"></span>
        Member→Company
      </div>
    </section>
  </main>

  <script>
    // ---- host sanity hint (repo view vs pages) ----
    (function(){
      const hint = document.getElementById('hostHint');
      const isRepoView = location.hostname === 'github.com' || location.pathname.includes('/blob/');
      if(isRepoView){
        hint.style.display = 'block';
        hint.textContent = 'Heads up: Open this via your GitHub Pages site (https://<user>.github.io/<repo>/). The repo viewer blocks fetching ./data.json.';
      }
    })();

    // ---- layout constants ----
    const memX = 300, memY = 260;
    const coX  = 1140, coY  = 260;
    const polY = 620,  polX = (420 + 980) / 2;

    const $ = id => document.getElementById(id);
    const NS = "http://www.w3.org/2000/svg";

    const S = {
      data: null,
      activeCompanyId: "",
      membersForCompany: [],
      artifactsForCompany: [],
      iM: 0, iA: 0,
      tickerToId: {}
    };

    function uniqBy(arr, keyFn){
      const seen = new Set(); const out=[];
      for(const x of arr){ const k=keyFn(x); if(!seen.has(k)){ seen.add(k); out.push(x); } }
      return out;
    }

    function hydrateForCompany(cid){
      const { members, artifacts, companies, edges } = S.data;
      const comp = companies.find(c=>c.id===cid);
      if(!comp) return { comp:null, mList:[], aList:[], ma:[], ac:[], mc:[] };

      const acEdges = (edges.artifact_company||[]).filter(e=>e.to===cid);
      const aIds = new Set(acEdges.map(e=>e.from));
      const aList = artifacts.filter(a=>aIds.has(a.id));

      const mcEdges = (edges.member_company||[]).filter(e=>e.to===cid);
      const maEdgesAll = (edges.member_artifact||[]).filter(e=>aIds.has(e.to));
      const mIds = new Set([...mcEdges.map(e=>e.from), ...maEdgesAll.map(e=>e.from)]);
      const mList = members.filter(m=>mIds.has(m.id));

      const ma = (edges.member_artifact||[]).filter(e=>mIds.has(e.from) && aIds.has(e.to));
      const ac = acEdges.slice();
      const mc = (edges.member_company||[]).filter(e=>mIds.has(e.from) && e.to===cid);

      return { comp, mList, aList, ma, ac, mc };
    }

    function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

    function drawMember(m){
      const g = $("member"); clear(g);
      if(!m) return;
      const node = document.createElementNS(NS,"g");
      node.setAttribute("transform", `translate(${memX-170},${memY-22})`);
      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width","340"); rect.setAttribute("height","44"); rect.setAttribute("rx","10");
      rect.setAttribute("fill","#0b1222"); rect.setAttribute("stroke","#334155");
      const t1 = document.createElementNS(NS,"text");
      t1.setAttribute("x","12"); t1.setAttribute("y","26"); t1.setAttribute("fill","#e5e7eb"); t1.setAttribute("font-weight","600");
      t1.textContent = m.name + (m.party || m.state ? ` (${[m.party, m.state].filter(Boolean).join("–")})` : "");
      const t2 = document.createElementNS(NS,"text");
      t2.setAttribute("x","328"); t2.setAttribute("y","26"); t2.setAttribute("text-anchor","end");
      t2.setAttribute("fill","#94a3b8"); t2.setAttribute("font-size","12");
      t2.textContent = m.role || "";
      node.append(rect,t1,t2);
      g.appendChild(node);
    }

    function drawArtifact(a){
      const g = $("artifact"); clear(g);
      if(!a) return;
      const node = document.createElementNS(NS,"g");
      node.setAttribute("transform", `translate(${polX-180},${polY-28})`);
      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width","360"); rect.setAttribute("height","56"); rect.setAttribute("rx","10");
      rect.setAttribute("fill","#0b1222"); rect.setAttribute("stroke","#334155");
      const t1 = document.createElementNS(NS,"text");
      t1.setAttribute("x","12"); t1.setAttribute("y","24"); t1.setAttribute("fill","#e5e7eb"); t1.setAttribute("font-weight","600");
      t1.textContent = a.short_title || a.title;
      const t2 = document.createElementNS(NS,"text");
      t2.setAttribute("x","12"); t2.setAttribute("y","40"); t2.setAttribute("fill","#94a3b8"); t2.setAttribute("font-size","12");
      t2.textContent = (a.type||"") + (a.status?` • ${a.status}`:"");
      node.append(rect,t1,t2);
      g.appendChild(node);
    }

    function drawCompany(c){
      const g = $("company"); clear(g);
      if(!c) return;
      const node = document.createElementNS(NS,"g");
      node.setAttribute("transform", `translate(${coX-180},${coY-22})`);
      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width","360"); rect.setAttribute("height","44"); rect.setAttribute("rx","10");
      rect.setAttribute("fill","#0b1222"); rect.setAttribute("stroke","#334155");
      const t1 = document.createElementNS(NS,"text");
      t1.setAttribute("x","12"); t1.setAttribute("y","28"); t1.setAttribute("fill","#e5e7eb"); t1.setAttribute("font-weight","600");
      t1.textContent = c.name + (c.ticker?` (${c.ticker})`:"");
      node.append(rect,t1);
      g.appendChild(node);
    }

    function drawEdgeWithLabel(gLine, gLabel, x1,y1,x2,y2, stroke, text){
      const line = document.createElementNS(NS,"line");
      line.setAttribute("x1",x1); line.setAttribute("y1",y1);
      line.setAttribute("x2",x2); line.setAttribute("y2",y2);
      line.setAttribute("stroke", stroke); line.setAttribute("stroke-width","2");
      line.setAttribute("stroke-linecap","round");
      gLine.appendChild(line);

      const midx = (x1+x2)/2, midy = (y1+y2)/2;
      const padX = 10;
      const estW = Math.max(70, Math.min(360, (text||"").length * 7 + padX*2));
      const estH = 24;

      const group = document.createElementNS(NS,"g");
      group.setAttribute("transform", `translate(${midx - estW/2},${midy - estH/2})`);

      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width", estW); rect.setAttribute("height", estH); rect.setAttribute("rx","8");
      rect.setAttribute("fill", "#0b1222"); rect.setAttribute("fill-opacity","0.85");
      rect.setAttribute("stroke", "#334155");

      const t = document.createElementNS(NS,"text");
      t.setAttribute("x", padX); t.setAttribute("y", estH/2 + 5);
      t.setAttribute("fill", "#e5e7eb"); t.setAttribute("font-size","12");
      t.textContent = text || "";

      group.append(rect,t);
      gLabel.appendChild(group);
    }

    function render(){
      const edgesMA = $("edges-ma"), edgesAC = $("edges-ac"), edgesMC = $("edges-mc"), labels = $("labels");
      clear(edgesMA); clear(edgesAC); clear(edgesMC); clear(labels);

      if(!S.activeCompanyId){
        $("member").innerHTML = "";
        $("artifact").innerHTML = "";
        $("company").innerHTML = "";
        $("mIdx").textContent = "0/0"; $("aIdx").textContent = "0/0";
        $("mName").textContent = "—";  $("aName").textContent = "—";
        $("prevM").disabled = $("nextM").disabled = $("prevA").disabled = $("nextA").disabled = true;
        $("openTimeline").disabled = true;
        return;
      }

      const { comp, mList, aList, ma, ac, mc } = hydrateForCompany(S.activeCompanyId);
      S.membersForCompany   = uniqBy(mList, m => m.id);
      S.artifactsForCompany = uniqBy(aList, a => a.id);

      if(S.iM >= S.membersForCompany.length) S.iM = 0;
      if(S.iA >= S.artifactsForCompany.length) S.iA = 0;

      const curM = S.membersForCompany[S.iM] || null;
      const curA = S.artifactsForCompany[S.iA] || null;

      drawCompany(comp);
      drawMember(curM);
      drawArtifact(curA);

      $("mIdx").textContent = `${S.membersForCompany.length?S.iM+1:0}/${S.membersForCompany.length}`;
      $("aIdx").textContent = `${S.artifactsForCompany.length?S.iA+1:0}/${S.artifactsForCompany.length}`;
      $("mName").textContent = curM ? `${curM.name}${curM.party||curM.state?` (${[curM.party, curM.state].filter(Boolean).join("–")})`:""}` : "—";
      $("aName").textContent = curA ? (curA.short_title || curA.title) : "—";

      if(curM && curA){
        const e = (ma||[]).find(e => e.from===curM.id && e.to===curA.id);
        const label = e?.note || e?.relation || "";
        drawEdgeWithLabel(edgesMA, labels, memX+20, memY, polX, polY-28, "#f59e0b", label);
      }
      if(curA){
        const e = (ac||[]).find(e => e.from===curA.id && e.to===comp.id);
        const parts = [];
        if(e?.via) parts.push(e.via);
        if(e?.agency) parts.push(e.agency);
        if(typeof e?.amount==="number") parts.push("$"+e.amount.toLocaleString());
        const label = e?.note || parts.join(" • ");
        drawEdgeWithLabel(edgesAC, labels, polX, polY-28, coX-180, coY, "#3b82f6", label);
      }
      if(curM){
        const e = (mc||[]).find(e => e.from===curM.id && e.to===comp.id);
        const label = e?.note || e?.relation || "";
        drawEdgeWithLabel(edgesMC, labels, memX+20, memY, coX-180, coY, "#ef4444", label);
      }

      $("prevM").disabled = $("nextM").disabled = S.membersForCompany.length<=1;
      $("prevA").disabled = $("nextA").disabled = S.artifactsForCompany.length<=1;
      $("openTimeline").disabled = !S.activeCompanyId;
    }

    function setCompanyById(cid){
      S.activeCompanyId = cid || "";
      S.iM = 0; S.iA = 0;
      const comp = S.data?.companies.find(c=>c.id===cid);
      $("tickerSelect").value = cid || "";
      if(comp) $("searchTicker").value = comp.ticker || "";
      render();
    }

    $("prevM").addEventListener("click", () => {
      if(S.membersForCompany.length){ S.iM = (S.iM-1+S.membersForCompany.length)%S.membersForCompany.length; render(); }
    });
    $("nextM").addEventListener("click", () => {
      if(S.membersForCompany.length){ S.iM = (S.iM+1)%S.membersForCompany.length; render(); }
    });
    $("prevA").addEventListener("click", () => {
      if(S.artifactsForCompany.length){ S.iA = (S.iA-1+S.artifactsForCompany.length)%S.artifactsForCompany.length; render(); }
    });
    $("nextA").addEventListener("click", () => {
      if(S.artifactsForCompany.length){ S.iA = (S.iA+1)%S.artifactsForCompany.length; render(); }
    });
    $("clearSel").addEventListener("click", () => setCompanyById(""));

    $("openTimeline").addEventListener("click", () => {
      if(!S.activeCompanyId) return;
      const comp = S.data.companies.find(c=>c.id===S.activeCompanyId);
      const t = (comp?.ticker || "").toUpperCase();
      window.location.href = `index2.html?ticker=${encodeURIComponent(t)}`;
    });

    $("searchTicker").addEventListener("change", (e)=>{
      const val = (e.target.value||"").trim().toLowerCase();
      const id = S.tickerToId[val];
      if(id) setCompanyById(id);
    });
    $("searchTicker").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        const val = (e.target.value||"").trim().toLowerCase();
        const id = S.tickerToId[val];
        if(id) setCompanyById(id);
      }
    });
    $("tickerSelect").addEventListener("change", (e)=> setCompanyById(e.target.value));

    // --- robust fetch of data.json ---
    function dataUrl(){ return new URL('./data.json', location.href).href; }

    fetch(dataUrl(), {cache:'no-store'})
      .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(d => {
        S.data = d;
        const dl = $("tickersList");
        const sel = $("tickerSelect");
        sel.innerHTML = `<option value="">Select a ticker…</option>`;
        d.companies.forEach(c=>{
          const t = (c.ticker||"").trim();
          if(t){
            S.tickerToId[t.toLowerCase()] = c.id;
            const o = document.createElement("option"); o.value = t; dl.appendChild(o);
          }
          const so = document.createElement("option");
          so.value = c.id; so.textContent = `${t || '—'} — ${c.name}`;
          sel.appendChild(so);
        });
        render();
      })
      .catch(err => {
        console.error('Failed to load data.json:', err);
        document.body.insertAdjacentHTML('beforeend','<div class="wrap"><div class="panel">Failed to load ./data.json. If you are viewing this on github.com, open your GitHub Pages URL instead.</div></div>');
      });
  </script>
</body>
</html>
