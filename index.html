<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gov → Policy → Public Co.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{ border:1px solid rgb(51,65,85); border-radius:1rem; background:rgba(2,6,23,.6); padding:.75rem }
    .btn{ border:1px solid rgb(51,65,85); border-radius:.75rem; padding:.5rem .75rem; background:rgba(15,23,42,.7) }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="sticky top-0 z-10 backdrop-blur bg-slate-950/80 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <h1 class="text-xl font-semibold">Gov → Policy → Public Co.</h1>
      <div class="mt-2 grid gap-2 sm:grid-cols-2">
        <input id="q" class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
               placeholder="Search policies (e.g., CHIPS, infrastructure, golden dome)" />
        <select id="policySelect" class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2">
          <option value="">Filter by policy…</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 grid gap-4 lg:grid-cols-3">
    <!-- Members -->
    <section>
      <h2 class="text-lg font-medium mb-3">Members</h2>
      <div id="members" class="grid gap-2 max-h-[75vh] overflow-auto"></div>
    </section>

    <!-- Policies -->
    <section>
      <h2 class="text-lg font-medium mb-3">Policies</h2>
      <div id="policies" class="grid gap-3 max-h-[75vh] overflow-auto"></div>
    </section>

    <!-- Impacts -->
    <section>
      <h2 class="text-lg font-medium mb-3">Impacted Companies</h2>
      <div class="text-xs text-slate-400 mb-2">Select a policy to load impacts by pages.</div>
      <div id="impacts" class="grid gap-2 max-h-[65vh] overflow-auto"></div>
      <div class="mt-3 flex items-center gap-2">
        <button id="loadMore" class="btn" disabled>Load more</button>
        <span id="pageInfo" class="text-xs text-slate-400"></span>
      </div>
    </section>
  </main>

  <script>
    const els = {
      members: document.getElementById('members'),
      policies: document.getElementById('policies'),
      impacts: document.getElementById('impacts'),
      q: document.getElementById('q'),
      policySelect: document.getElementById('policySelect'),
      loadMore: document.getElementById('loadMore'),
      pageInfo: document.getElementById('pageInfo'),
    };

    const S = {
      manifest: null,
      members: [],
      policies: [],
      activeUID: '',
      page: 0,
      pages: 0,
    };

    // ---------- helpers ----------
    const j = (p) => fetch(p).then(r => { if(!r.ok) throw new Error(p); return r.json(); });

    function renderMembers(list){
      els.members.innerHTML = list.map(m => `
        <div class="card">
          <div class="font-semibold">${m.name}</div>
          <div class="text-xs text-slate-400">
            ${(m.chamber||'').toUpperCase()}${m.state?(' • '+m.state):''}${m.party?(' • '+m.party):''}
          </div>
          ${m.role?`<div class="text-xs text-slate-400 mt-1">${m.role}</div>`:''}
        </div>`).join('');
    }

    function renderPolicies(){
      const q = (els.q.value||'').toLowerCase();
      const filtered = S.policies.filter(p =>
        !q || [p.title, p.short_title, p.status, ...(p.tags||[])]
              .join(' ').toLowerCase().includes(q)
      );
      els.policies.innerHTML = filtered.map(p => `
        <button class="card text-left hover:bg-slate-900/80" data-uid="${p.uid}">
          <div class="font-semibold">${p.title}</div>
          <div class="text-xs text-slate-400">${p.short_title||''}</div>
          <div class="text-xs text-slate-400 mt-1">${p.status||'—'}${p.impacts_total!=null?` • impacts: ${p.impacts_total}`:''}</div>
          ${Array.isArray(p.tags)&&p.tags.length?`<div class="mt-2 flex flex-wrap gap-1">
            ${p.tags.map(t=>`<span class='text-[10px] px-2 py-0.5 rounded-full bg-slate-800 border border-slate-700'>${t}</span>`).join('')}
          </div>`:''}
        </button>`).join('');
    }

    function fillPolicyDropdown(list){
      els.policySelect.innerHTML = `<option value="">Filter by policy…</option>` +
        list.map(p => `<option value="${p.uid}">${p.short_title || p.title.slice(0,80)}</option>`).join('');
    }

    function resetImpacts(){
      els.impacts.innerHTML = '';
      els.pageInfo.textContent = '';
      els.loadMore.disabled = true;
      S.page = 0; S.pages = 0;
    }

    async function loadImpactsPage(uid, page){
      const safe = uid; // uid like 118_hr_1234
      const path = `data/impacts-${safe}-p${page}.json`;
      const rows = await j(path);
      const html = rows.map(im => `
        <div class="card">
          <div class="font-semibold">${im.company.name}${im.company.ticker?` (${im.company.ticker})`:''}</div>
          <div class="text-xs text-slate-400">Policy: ${im.policy_title || uid}</div>
          <div class="text-xs text-slate-400">Link: ${im.link_type || '—'} • conf ${Math.round((im.confidence||0)*100)}%</div>
          ${im.via_award?`<div class='text-xs text-slate-300 mt-1'>$${Number(im.via_award.amount).toLocaleString()} • ${im.via_award.award_type} • ${im.via_award.awarding_agency}</div>`:''}
        </div>`).join('');
      els.impacts.insertAdjacentHTML('beforeend', html);
    }

    async function selectPolicy(uid){
      S.activeUID = uid;
      resetImpacts();
      if (!uid) return;
      const meta = S.manifest?.impacts?.[uid];
      S.pages = meta?.pages || 0;
      els.loadMore.disabled = S.pages <= 0;
      if (S.pages > 0) await nextPage();
    }

    async function nextPage(){
      if (!S.activeUID || S.page >= S.pages) return;
      const next = S.page + 1;
      els.loadMore.disabled = true;
      try {
        await loadImpactsPage(S.activeUID, next);
        S.page = next;
        els.pageInfo.textContent = `Page ${S.page} / ${S.pages}`;
      } catch(e){ console.error(e); }
      els.loadMore.disabled = (S.page >= S.pages);
    }

    // ---------- bootstrap ----------
    Promise.all([
      j('data/manifest.json'),
      j('data/members.json'),
      j('data/policies.json'),
    ]).then(([manifest, members, policies]) => {
      S.manifest = manifest; S.members = members; S.policies = policies;
      renderMembers(members);
      renderPolicies();
      fillPolicyDropdown(policies);
    }).catch(err => console.error('Init load failed', err));

    // events
    els.q.addEventListener('input', renderPolicies);
    els.policySelect.addEventListener('change', e => selectPolicy(e.target.value));
    els.policies.addEventListener('click', e => {
      const b = e.target.closest('button[data-uid]');
      if (b) { els.policySelect.value = b.dataset.uid; selectPolicy(b.dataset.uid); }
    });
    els.loadMore.addEventListener('click', nextPage);
  </script>
</body>
</html>
