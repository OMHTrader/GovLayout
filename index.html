<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gov → Policy → Public Co. (Triangle)</title>
  <style>
    :root{ --bg:#0f172a; --panel:#0b1222; --text:#e5e7eb; --sub:#94a3b8; --border:#334155; }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      background:var(--bg); color:var(--text); font-size:18px; line-height:1.45;
    }
    header{ position:sticky; top:0; background:#0f172ad0; border-bottom:1px solid var(--border); backdrop-filter:saturate(1.05) blur(6px); }
    .wrap{ max-width:1400px; margin:0 auto; padding:12px 16px; }
    h1{ margin:0; font-size:22px }
    input{
      width:100%; background:#0b1222; color:var(--text); border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; font-size:16px; margin-top:10px;
    }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .muted{ color:var(--sub); font-size:14px }
    svg text{ font-family:inherit }
    .legend span{ display:inline-block; width:14px; height:3px; margin-right:8px; vertical-align:middle; border-radius:2px }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Gov → Policy → Public Co. (Upside-Down Triangle)</h1>
      <input id="search" placeholder="Search (ticker › member › policy)…" />
    </div>
  </header>

  <main class="wrap" style="padding-top:12px">
    <section class="panel" style="overflow:hidden">
      <svg id="canvas" viewBox="0 0 1400 700" preserveAspectRatio="xMidYMid meet" style="width:100%;height:66vh">
        <!-- Faint guides -->
        <g fill="none" stroke="rgba(255,255,255,.06)">
          <line x1="300" y1="0" x2="300" y2="700"/>   <!-- members column -->
          <line x1="700" y1="0" x2="700" y2="700"/>   <!-- center -->
          <line x1="1140" y1="0" x2="1140" y2="700"/> <!-- companies column -->
          <line x1="360" y1="600" x2="1040" y2="600"/> <!-- policies baseline -->
        </g>

        <!-- Labels -->
        <g font-size="14" fill="#94a3b8">
          <text x="110"  y="30">Branches & Members</text>
          <text x="1210" y="30">Public Companies</text>
          <text x="640"  y="680">Policies / Laws / Rulings</text>
        </g>

        <!-- Edges behind nodes -->
        <g id="edges-ma" fill="none" stroke="#f59e0b" stroke-opacity=".85"></g> <!-- member→artifact (amber) -->
        <g id="edges-ac" fill="none" stroke="#3b82f6" stroke-opacity=".85"></g> <!-- artifact→company (blue) -->
        <g id="edges-mc" fill="none" stroke="#ef4444" stroke-opacity=".85"></g> <!-- member→company (red) -->

        <!-- Nodes -->
        <g id="members"></g>    <!-- left -->
        <g id="artifacts"></g>  <!-- bottom baseline -->
        <g id="companies"></g>  <!-- right -->

        <!-- Edge labels on top (so line appears “through” translucent box) -->
        <g id="labels"></g>
      </svg>

      <div class="muted legend" style="margin-top:10px">
        <span style="background:#f59e0b"></span> Member → Policy/Law/Ruling
        &nbsp;&nbsp; <span style="background:#3b82f6"></span> Policy/Law/Ruling → Company
        &nbsp;&nbsp; <span style="background:#ef4444"></span> Member → Company
      </div>
    </section>
  </main>

  <script>
    // ---- layout ----
    const memX = 300, memY0 = 120, memGapBranch = 120, memDy = 48; // left column
    const coX  = 1140, coY0 = 120, coDy = 60;                       // right column
    const baseY = 600, baseLeft = 380, baseRight = 1020;            // bottom baseline for policies

    const $ = id => document.getElementById(id);
    const NS = "http://www.w3.org/2000/svg";

    const S = { data:null, q:"" };

    // search priority: ticker > member > policy
    function computeFiltered(){
      const q = (S.q||"").trim().toLowerCase();
      const all = S.data;

      if(!q){
        return {
          members: all.members.slice(),
          artifacts: all.artifacts.slice(),
          companies: all.companies.slice(),
          ma: all.edges.member_artifact.slice(),
          ac: all.edges.artifact_company.slice(),
          mc: all.edges.member_company ? all.edges.member_company.slice() : []
        };
      }

      // 1) company by ticker (then name)
      const cTicker = all.companies.filter(c =>
        (c.ticker && c.ticker.toLowerCase().includes(q)) ||
        (c.name && c.name.toLowerCase().includes(q))
      );
      if(cTicker.length){
        const cSet = new Set(cTicker.map(c=>c.id));
        const ac = all.edges.artifact_company.filter(e=>cSet.has(e.to));
        const mc = (all.edges.member_company||[]).filter(e=>cSet.has(e.to));
        const aSet = new Set(ac.map(e=>e.from));
        const mSet = new Set(mc.map(e=>e.from));
        return {
          companies: all.companies.filter(c=>cSet.has(c.id)),
          artifacts: all.artifacts.filter(a=>aSet.has(a.id)),
          members:  all.members.filter(m=>mSet.has(m.id)),
          ma: all.edges.member_artifact.filter(e=>mSet.has(e.from) && aSet.has(e.to)),
          ac, mc
        };
      }

      // 2) members by name/role/party/state
      const mHit = all.members.filter(m => (m.name + " " + (m.role||"") + " " + (m.party||"") + " " + (m.state||""))
                               .toLowerCase().includes(q));
      if(mHit.length){
        const mSet = new Set(mHit.map(m=>m.id));
        const ma = all.edges.member_artifact.filter(e=>mSet.has(e.from));
        const mc = (all.edges.member_company||[]).filter(e=>mSet.has(e.from));
        const aSet = new Set(ma.map(e=>e.to));
        const cSet = new Set(mc.map(e=>e.to));
        return {
          members:  all.members.filter(m=>mSet.has(m.id)),
          artifacts: all.artifacts.filter(a=>aSet.has(a.id)),
          companies: all.companies.filter(c=>cSet.has(c.id)),
          ma, mc,
          ac: all.edges.artifact_company.filter(e=>aSet.has(e.from) && cSet.has(e.to))
        };
      }

      // 3) policies by title/short_title
      const aHit = all.artifacts.filter(a => (a.title + " " + (a.short_title||"")).toLowerCase().includes(q));
      if(aHit.length){
        const aSet = new Set(aHit.map(a=>a.id));
        const ma = all.edges.member_artifact.filter(e=>aSet.has(e.to));
        const ac = all.edges.artifact_company.filter(e=>aSet.has(e.from));
        const mSet = new Set(ma.map(e=>e.from));
        const cSet = new Set(ac.map(e=>e.to));
        return {
          artifacts: all.artifacts.filter(a=>aSet.has(a.id)),
          members:   all.members.filter(m=>mSet.has(m.id)),
          companies: all.companies.filter(c=>cSet.has(c.id)),
          ma, ac,
          mc: (all.edges.member_company||[]).filter(e=>mSet.has(e.from) && cSet.has(e.to))
        };
      }

      return { members:[], artifacts:[], companies:[], ma:[], ac:[], mc:[] };
    }

    function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

    function drawMember(g, m){
      const node = document.createElementNS(NS, "g");
      node.setAttribute("class","node member");
      node.setAttribute("data-id", m.id);
      node.setAttribute("transform", `translate(${m._x-170},${m._y-22})`);
      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width","340"); rect.setAttribute("height","44"); rect.setAttribute("rx","10");
      rect.setAttribute("fill","#0b1222"); rect.setAttribute("stroke","#334155");
      const t1 = document.createElementNS(NS,"text");
      t1.setAttribute("x","12"); t1.setAttribute("y","26"); t1.setAttribute("fill","#e5e7eb"); t1.setAttribute("font-weight","600");
      t1.textContent = m.name + (m.party || m.state ? ` (${[m.party, m.state].filter(Boolean).join("–")})` : "");
      const t2 = document.createElementNS(NS,"text");
      t2.setAttribute("x","328"); t2.setAttribute("y","26"); t2.setAttribute("text-anchor","end");
      t2.setAttribute("fill","#94a3b8"); t2.setAttribute("font-size","12");
      t2.textContent = m.role || "";
      node.append(rect,t1,t2);
      g.appendChild(node);
    }

    function drawArtifact(g, a){
      const node = document.createElementNS(NS,"g");
      node.setAttribute("class","node artifact");
      node.setAttribute("data-id", a.id);
      node.setAttribute("transform", `translate(${a._x-180},${a._y-28})`);
      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width","360"); rect.setAttribute("height","56"); rect.setAttribute("rx","10");
      rect.setAttribute("fill","#0b1222"); rect.setAttribute("stroke","#334155");
      const t1 = document.createElementNS(NS,"text");
      t1.setAttribute("x","12"); t1.setAttribute("y","24"); t1.setAttribute("fill","#e5e7eb"); t1.setAttribute("font-weight","600");
      t1.textContent = a.short_title || a.title;
      const t2 = document.createElementNS(NS,"text");
      t2.setAttribute("x","12"); t2.setAttribute("y","40"); t2.setAttribute("fill","#94a3b8"); t2.setAttribute("font-size","12");
      t2.textContent = (a.type||"") + (a.status?` • ${a.status}`:"");
      node.append(rect,t1,t2);
      g.appendChild(node);
    }

    function drawCompany(g, c){
      const node = document.createElementNS(NS,"g");
      node.setAttribute("class","node company");
      node.setAttribute("data-id", c.id);
      node.setAttribute("transform", `translate(${c._x-180},${c._y-22})`);
      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width","360"); rect.setAttribute("height","44"); rect.setAttribute("rx","10");
      rect.setAttribute("fill","#0b1222"); rect.setAttribute("stroke","#334155");
      const t1 = document.createElementNS(NS,"text");
      t1.setAttribute("x","12"); t1.setAttribute("y","28"); t1.setAttribute("fill","#e5e7eb"); t1.setAttribute("font-weight","600");
      t1.textContent = c.name + (c.ticker?` (${c.ticker})`:"");
      node.append(rect,t1);
      g.appendChild(node);
    }

    // straight line + centered translucent label so the line shows “through”
    function drawEdgeWithLabel(gLine, gLabel, x1,y1,x2,y2, stroke, text){
      const line = document.createElementNS(NS,"line");
      line.setAttribute("x1",x1); line.setAttribute("y1",y1);
      line.setAttribute("x2",x2); line.setAttribute("y2",y2);
      line.setAttribute("stroke", stroke); line.setAttribute("stroke-width","2");
      gLine.appendChild(line);

      const midx = (x1+x2)/2, midy = (y1+y2)/2;
      const padX = 10, padY = 6;
      const estW = Math.max(70, Math.min(280, (text||"").length * 7 + padX*2));
      const estH = 24;

      const group = document.createElementNS(NS,"g");
      group.setAttribute("transform", `translate(${midx - estW/2},${midy - estH/2})`);

      const rect = document.createElementNS(NS,"rect");
      rect.setAttribute("width", estW); rect.setAttribute("height", estH); rect.setAttribute("rx","8");
      rect.setAttribute("fill", "#0b1222"); rect.setAttribute("fill-opacity","0.85");
      rect.setAttribute("stroke", "#334155");

      const t = document.createElementNS(NS,"text");
      t.setAttribute("x", padX); t.setAttribute("y", estH/2 + 5);
      t.setAttribute("fill", "#e5e7eb"); t.setAttribute("font-size","12");
      t.textContent = text || "";

      group.append(rect,t);
      gLabel.appendChild(group);
    }

    function render(){
      const { members, artifacts, companies, ma, ac, mc } = computeFiltered();

      // positions
      const byBranch = { legislative:[], executive:[], judicial:[] };
      members.forEach(m => (byBranch[m.branch]||byBranch.legislative).push(m));
      const starts = { legislative: memY0, executive: memY0 + memGapBranch, judicial: memY0 + memGapBranch*2 };
      Object.keys(byBranch).forEach(br => {
        byBranch[br].forEach((m,i)=>{ m._x = memX; m._y = (starts[br]||memY0) + i*memDy; });
      });

      const nA = Math.max(artifacts.length, 1);
      const span = Math.max(baseRight - baseLeft, 200);
      const dx = nA === 1 ? 0 : span / (nA - 1);
      artifacts.forEach((a,i)=>{ a._x = baseLeft + i*dx; a._y = baseY; });

      companies.forEach((c,i)=>{ c._x = coX; c._y = coY0 + i*coDy; });

      const M = Object.fromEntries(members.map(m=>[m.id,m]));
      const A = Object.fromEntries(artifacts.map(a=>[a.id,a]));
      const C = Object.fromEntries(companies.map(c=>[c.id,c]));

      const gM=$('members'), gA=$('artifacts'), gC=$('companies'),
            gMA=$('edges-ma'), gAC=$('edges-ac'), gMC=$('edges-mc'), gL=$('labels');
      clear(gM); clear(gA); clear(gC); clear(gMA); clear(gAC); clear(gMC); clear(gL);

      // nodes
      members.forEach(m=>drawMember(gM,m));
      artifacts.forEach(a=>drawArtifact(gA,a));
      companies.forEach(c=>drawCompany(gC,c));

      // edges + labels
      ma.forEach(e=>{
        const m=M[e.from], a=A[e.to]; if(!m||!a) return;
        const label = e.note || e.relation || "";
        drawEdgeWithLabel(gMA, gL, m._x+20, m._y, a._x, a._y-30, "#f59e0b", label);
      });

      ac.forEach(e=>{
        const a=A[e.from], c=C[e.to]; if(!a||!c) return;
        const parts = [];
        if(e.via) parts.push(e.via);
        if(e.agency) parts.push(e.agency);
        if(typeof e.amount==="number") parts.push("$"+e.amount.toLocaleString());
        const label = e.note || parts.join(" • ");
        drawEdgeWithLabel(gAC, gL, a._x, a._y-30, c._x-180, c._y, "#3b82f6", label);
      });

      (mc||[]).forEach(e=>{
        const m=M[e.from], c=C[e.to]; if(!m||!c) return;
        const label = e.note || e.relation || "";
        drawEdgeWithLabel(gMC, gL, m._x+20, m._y, c._x-180, c._y, "#ef4444", label);
      });
    }

    // events
    document.getElementById('search').addEventListener('input', e => { S.q = e.target.value; render(); });

    // boot
    fetch('./data.json')
      .then(r=>r.json())
      .then(d => { S.data = d; render(); })
      .catch(err => {
        console.error(err);
        document.body.insertAdjacentHTML('beforeend','<div class="wrap"><div class="panel">Failed to load ./data.json</div></div>');
      });
  </script>
</body>
</html>
